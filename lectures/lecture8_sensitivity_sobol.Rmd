---
title: "Sensitivity_sobol"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sensitivity)
library(pse)
library(tidyverse)
library(gridExtra)
library(purrr)
library(ggpubr)
```

# Example (Using Function from Last Assignment)

Atmospheric Conductance as a function of windspeed, vegetation height and parameters


```{r setsen, echo=TRUE, eval=TRUE}

source("../R/Catm.R")
# names of our parameters
factors = c("k_o","k_d", "v","height")
# type of distributions they arise from
q = c("qnorm", "qnorm", "qnorm","qunif")
# parameters for those distributions
q.arg = list(list(mean=0.1,sd=0.1*0.1), list(mean=0.7, sd=0.7*0.1), list(mean=200, sd=10), 
             list(min=5, max=15))

nsets=200
sens_Catm = LHS(NULL,factors,nsets,q,q.arg, nboot=500)
# save parameter values
sens.pars = get.data(sens_Catm)

head(sens.pars)
ggplot(sens.pars, aes(k_o))+geom_density()
ggplot(sens.pars, aes(x=k_o, y=k_d))+geom_density_2d()
```

# Sensitivity Analysis Steps

Now run the model - and give results to sensitivity analysis data structure generated by LHS 

Take advantage of LHS functions for plotting and analysis

**tell**

provides the sensitivity structure created by LHS, results from model simulations

* can also provide names for results

# LHS Plotting Commands



* **plotscatter**
  * given x-y plot of parameter and result
* **plotprcc**
  * Partial rank correlation coefficient 
* **plotecdf**
  * Empirical Cummulative Distribution
  
# Run model for parameter sample

```{r runsen, echo=TRUE, eval=TRUE}

# run the model
source("../R/Catm.R")
sens_res = Catm(v=sens.pars$v, height=sens.pars$height, k_o=sens.pars$k_o, k_d=sens.pars$k_d)

sens_Catm = tell(sens_Catm, sens_res, res.names="ga")


# note it can take standard R plotting parameters
plotscatter(sens_Catm, col="darkgreen", cex=5, ylab="Atm Cond (mm/s)")


# we can also plot partial correlation coefficients
plotprcc(sens_Catm)
# and we can look at the actual values

sens_Catm$prcc

```

# Cummulative Distribution

Empirical Cummulative Distribution is often plotted to provide information about distribution of output responses (across uncertainty in parameters)

Shows how results are distributed across the range

Similar to boxplot but more informative

* **plotecdf** works with LHS object

* **stat_ecdf** works with ggplot

Lets compare boxplot, density plots and ecdfs

 
```{r cd}
# whats is the range of results

plotecdf(sens_Catm, col="red", lwd=5, xlab="Atm Cond (mm/s)")

# Interpreting ECDF's - a quick review
# example - more values at the low end - skewed towards low values
example_low = c(runif(min=0, max=10, n=80), runif(min=11, max=40, n=20))
  
  
a=ggplot(as.data.frame(example_low), aes(y=example_low))+geom_boxplot()
b=ggplot(as.data.frame(example_low), aes(x=example_low))+geom_density()
c=ggplot(as.data.frame(example_low), aes(x=example_low))+stat_ecdf(geom="line", col="lightblue",lwd=2)
ggarrange(a,b,c)


# skewed high
example_high = c(runif(min=20, max=40, n=80), runif(min=0, max=20, n=20))
  
  

b2=ggplot(as.data.frame(example_high), aes(x=example_high))+geom_density()
c2=ggplot(as.data.frame(example_high), aes(x=example_high))+stat_ecdf(geom="line", col="red",lwd=2)
ggarrange(b,c,b2,c2)

# even distribution
example_even = runif(min=0, max=40, n=100) 
# now plot all ecdf's together
ggplot(as.data.frame(example_even), aes(x=example_even))+stat_ecdf(geom="line", lwd=2)+
  stat_ecdf(data=as.data.frame(example_high), aes(x=example_low), geom="line", col="red", lwd=2) +
  stat_ecdf(data=as.data.frame(example_low), aes(x=example_high), geom="line", col="lightblue", lwd=2)+
  labs(y="ECDF", x="Example Value")+theme_bw()

```

# Sobol

Sobol sensitivity analysis is similar to LHS approach as a way to efficiently sample parameter space 

Sobol is more general - it can use measured parameter samples (we will approximate sampling here by using known distributions but you could use actual samples!)

Sobol is a *variance-based* method

Sobol quantifies sensitivity by 
breaking the variance of output into 

* variance associated directly with parameter alone (fraction associated with each parameter, sum to 1


<span style="color: green;">First order sensitivity or Main Effect</span>


* variance associated with parameter and interaction with other parameters (sum can be more than 1) 

<span style="color: green;">Total Effect</span>


# Sobol in R

* *Sensitivity* package

* Sobol Indices require estimation - and there are different methods to do that

* The *Sensitivity* package has several of those

* today we will use *sobolSalt* - which uses a method by Saltelli (who has written extensively on Sensitivity analysis)

* R help pages for *Sensitivity* provide many good references

* This is a nice overview paper

[Variance Based Methods](https://www.sciencedirect.com/science/article/pii/S0010465509003087?casa_token=xG4MJV4hwJgAAAAA:Tq_CLHTqtM1wDvhzviZFgm6sVBdOoYzQdFfOGplEi5OUxLSWxaKITce-CzxLxfS6993rNnbK1Q)

# Sobol - how to

Similar workflow to LHS

* run Sobol to get parameter sets in a sensitivity analysis object
* run model with those parameter sets
* tell the senstivity object about results associated with each parameter set
* look at sensitivity analysis metric from Sobol

Generation of parameter sets slightly different

  * generate two samples of parameter sets by 
  samplng from apriori (expected) distributions
  * these would be the distributions you used for LHS

#  Example 
Atmospheric Conductance as a function of windspeed, vegetation height and parameters

```{r}

source("../R/Catm.R")

# generate two examples of random number from parmeter distributions

np=1000
k_o = rnorm(mean=0.1,sd=0.1*0.1, n=np)
k_d = rnorm(mean=0.7, sd=0.7*0.1, n=np)
v = rnorm(mean=200, sd=10, n=np)
height = runif(min=5, max=15, n=np)


X1 = cbind.data.frame(k_o, k_d, v, height=height)

# repeat sampling
k_o = rnorm(mean=0.1,sd=0.1*0.1, n=np)
k_d = rnorm(mean=0.7, sd=0.7*0.1, n=np)
v = rnorm(mean=200, sd=10, n=np)
height = runif(min=5, max=15, n=np)

X2 = cbind.data.frame(k_o, k_d, v, height=height)

# there are different versions of sobol functions that have different approaches for estimating parameters and indices, we use an approach implemented by jansen 

sens_Catm_Sobol = sobolSalt(model = NULL, X1, X2, nboot = 100)


# Take a look at the Sobol generated sensitivity object
# your parameters sets for sensitivity analysis are in X

# run model for all parameter sets
# make sure you give the parameters names

parms = as.data.frame(sens_Catm_Sobol$X)
colnames(parms)= colnames(X1)
res = pmap_dbl(parms, Catm)


sens_Catm_Sobol = sensitivity::tell(sens_Catm_Sobol,res, res.names="ga")

# main effect:  partitions variance (main effect without co-variance) - sums approximately to one
sens_Catm_Sobol$S
# useful to add names
row.names(sens_Catm_Sobol$S) = colnames(parms)
sens_Catm_Sobol$S

# total effect - accounts for parameter interactions
row.names(sens_Catm_Sobol$T) = colnames(parms)
sens_Catm_Sobol$T

# Both the main effect and total effect can tell us something about how the parameter influences results


print(sens_Catm_Sobol)


# compare with LHS and PRCC
sens_Catm$prcc


sens_Catm_Sobol$S

sens_Catm_Sobol$T

# make a data frame for plotting
both = cbind.data.frame(parms, gs=sens_Catm_Sobol$y)

# look at response of conductance to the two most important variables
ggplot(both, aes(v,gs, col=height))+geom_point()+labs(y="Conductance (mm/s)", x="Windspeed")

```
