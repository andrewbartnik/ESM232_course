---
title: "lecture12_growth"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sensitivity)
library(tidyverse)
library(deSolve)
```
# Ways to use dynamic models 

Goal: To provide insight into environmental systems, and how they respond to intervention/disturbance/change

* sensitivity analysis of output (output generated by solving differential equation to see system evolution in time or space)
  * output response to variation in inputs/parameters
  * quantifying how summary measures respond to variation in inputs/parameters
* examine derivative at different values (simpler, not solving required but just tells you how system will change given a particular state)
  * how does stability vary with inputs/parameters

# Another Application

Modeling carbon growth in a forest

r is growth rate
K is maximum carbon capacity of the forest



# Disturbance

What would our model look like if we harvest the forest on a regular basis

2 options

*a fixed harvest every year

*proportional harvest (% of current stock)


```{r harvest}

# fixed amount per year
source("../R/dharvest.R")
dharvest

# try it out
tm = seq(from=1, to=500)
Pinitial = 1
gps = list(harv=0.18, K=100, r=0.2)
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()

# what if we harvest a a much greater rates

# lets vary the harvest rates from 0.0 to 0.4
harvestr = seq(from=0.0, to=0.4, by=0.025)

# save all of the trajectories


# use a wrapper function to just return the carbon trajectories
getcarbon = function(Pinitial, tm, harv, K, r, hfunc) {
  gps = list(harv=harv, K=K, r=r)
  res = ode(Pinitial,tm, hfunc, gps)
  colnames(res)=c("time","carbon")
  res=as.data.frame(res)
  return(carbon=res$carbon)
}

# apply this function to all harvest values
res = harvestr %>% map_dfc(~getcarbon( Pinitial=Pinitial, tm=tm, K=100, r=0.2, hfun=dharvest, harv=.x))
# rows are time, columns are carbon for each harvest scenario
colnames(res)=harvestr
res=as.data.frame(res)
res$time=tm
# put in to a form where we can plot
resl = gather(res, key="harvestr",value="carbon", -time)
ggplot(resl,aes(time, carbon, col=harvestr))+geom_line()


# notice that stable forest value changes with harvest rates

# notes that some forests are not stable - (or stablity is zero)

# see this at the beginning - plot the first 10 years
ggplot(subset(resl, time < 10),aes(time, carbon, col=harvestr))+geom_line()

```

# Stability


See last class for sensitivity analysis to see how harvest rate, and growth rate interact to control where the forest ends up after 10 years and 50 years (short and long planning horizons)


We can look at how the derivative (rate of change varies)


One way we can do this WITHOUT solving the differential equation is to look at the derivatives at different values

When the derivative is 0 the system is stable
Positive derivatives are growth
Negative are decline

```{r stability2}

# given some forest characteristics - lets look at derivatives under different harvest rates
lowHrate = 0.015
gps = list(harv=lowHrate, K=100, r=0.05)

# look at the derivative over a range of forest sizes

findstable = data.frame(Ccurr=seq(from=1, to=100, by=5))
# notice use of Time=NULL, and map to compute derivative
# for different values of forest biomass
findstable$dervHlow= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
                                                  
ggplot(findstable, aes(Ccurr, dervHlow))+geom_point()+geom_hline(yintercept = 0, col="red")

# Populations will be stable when derivative is zero!

# look at a different harvest rate
midHrate=0.02
gps = list(harv=midHrate, K=100, r=0.05)
findstable$dervHmid= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 
# try high rate
highHrate=0.05
gps = list(harv=highHrate, K=100, r=0.05)
findstable$dervHhigh= unlist(findstable$Ccurr %>% map(~dharvest(parms=gps, Time=NULL, P=.x) ))
 

# plot them all together
tmp = gather(findstable, key="HarvestRate", value="value", -Ccurr)
ggplot(tmp, aes(Ccurr, value, color=HarvestRate))+geom_point()+geom_hline(yintercept = 0, col="black")+
  labs(x="Forest Biomass", y="Forest Growth Rate")

# notice how with higher harvest rates the stable population will be lower




```

# Stability in changing systems - just looking at dervatives

Knowing the stability can help you understand the dynamics ofthe system

If we start with a Forest Carbon of 50 and low harvest rate what will happen

If we start with a Forest Carbon of 50 and a high harvest rate what will happen

Try it to find out if you are right
```{r}

gps = list(harv=lowHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()


gps = list(harv=highHrate, K=100, r=0.05)
Pinitial=50
res = ode(Pinitial,tm, dharvest, gps)
colnames(res)=c("time","carbon")
ggplot(as.data.frame(res), aes(time, carbon))+geom_point()



```


We can more formally find stablity by finding when the derviative of the function is zero




What if we have a slightly different forest management task -  to make harvest a fixed amount of  carbon but only take it if it is above a threshold minimum carbon

Think about how you would explore stability here

```{r stability}

source("../R/dharvestfixed.R")

# try it out
tm = seq(from=1, to=500)
Pinitial = 500
gps = list(harv=0.015, K=1000, r=0.05, mincarbon=20)

res = ode(Pinitial,tm, dharvestfixed, gps)
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_point()

#  try a different solver
res = ode(Pinitial,tm, dharvestfixed, gps, method="euler")
colnames(res)=c("time","carbon")

ggplot(as.data.frame(res), aes(time, carbon))+geom_line()


```

Consider the following model of forest growth (where forest size in measured in units of carbon (C))

dC/dt  = r*C  for forests where C is below a threshold canopy closure


dC/dt = g*(1- C/K) for forests where carbon is  at or above the threshold canopy closure
and K is a carrying capacity in units of carbon







The size of the forest (C), Canopy closure threshold and carrying capacity are all in units of carbon 



You could think of the canopy closure threshold as the size of the forest at which growth rates change from exponential to linear



You can think of r, as early exponential growth rate and g as the linear growth rate once canopy closure has been reached

Here's what you will do



1. Implement this model in R (as a differential equation)



2. Run the model for 300 years (using the ODE solver)  starting with an initial forest size of 10 kg/C, and using the following parameters



canopy closure threshold of 50 kgC 



 K = 250 kg C (carrying capacity) 



 r=  0.01 (exponential growth rate before before canopy closure)



 g = 2 kg/year (linear growth rate after canopy closure)



Graph the results



3. Run a sobol sensitivity analysis that explores how the estimated maximum and mean forest size (e.g maximum and mean values of C over the 300 years) varies with the pre canopy closure growth rate (r) and post-canopy closure growth rate (g) and canopy closure threshold and carrying capacity(K)

Assume that they are all normally distributed with means as given above and standard deviation of 10% of mean value

Graph the results of the sensitivity analysis as a box plot of maximum forest size and a plot of the two sobol indices (S and T)



Submit R markdown with model implementation, graphs and sensitivity analysis and R file with your model

