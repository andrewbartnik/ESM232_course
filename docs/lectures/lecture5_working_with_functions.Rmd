---
title: "Functions/Models with Data"
output:
  slidy_presentation:
    highlight: pygments
  html_document: default
  pdf_document: default
  ioslides_presentation:
    highlight: pygments
  beamer_presentation:
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

library(purrr)

library(ggpubr)

```


# Lists (Short Review) - 

For returning more than one item from your function

* Lists are the most “informal” data structures in R

* List are really useful for keeping track of and organizing groups of things that are not all the same

* A list could be a table where number of rows is different for each column

* A list can have numeric, character, factors all mixed together

*  List are often used for returning more complex information from function (e.g. lm)

# Examples 

Here are some examples of how to create and manipulate lists

```{r lists}
# simple list
sale =  list(number=c(2,4,9), quality="high", what="apple", cost=4)
sale
sale$cost
sale$number
sale[4]

```

# Lists and Functions

Lists are used to return multiple values from functions


<center>
**return(list(....))**
</center>

# Example - Biodiversity function

 * clone [ESM232_examples](https://github.com/naomitague/ESM232_Examples.git)
 
 * take a look at the *compute_diversity* function (in *R* subdirectory) - any questions about what it does?
 
# Sample data for Biodiversity Function
```{r}

# get the function
source("../R/compute_diversity.R")

# sampling categorical data
# create possible values
flower_types = c("iris","daisy","poppy","rose","dandelion","weed","violet")
# sample (with replacement)
garden = sample(flower_types, size=20, replace=T)
compute_diversity(garden)
```
 
 * modify to also return the *rarest* species
 
# Parameters - User controls on what your function does

Parameters in the function definition can be used to give users options that determine what calculations or actions are done in the function
(model)

This allows functions to be more flexible

*  model of ecosystem production that changes calculations if vegetation is grass versus a tree

* crop  model where user choses which function to run by specifying tree type



Built in R functions do this alot - they allow users to specify methods (**glm** for example, alows family to set the type of model - binomial or gaussian) 

# More on running functions with data

Design -  function that estimates solar pv power given inputs of radiation

Model inputs: solar radiation (daily direct and diffuse)

Model outputs: power generated each year and average power over time

Parameters: panel efficiency, system performance, units, type of array (uses diffuse or not), plot Y/N

Some of these options such as whether to plot determine outputs from the function

AND the type of array to determine whether it uses diffuse radiation, 
these parameters change how the function/model works

```{r solar}
source("../R/solarpv.R")
solarpv

# read in R formatted data
load("../Data/sierraczosolar.rda")

# already in the format required for the model
head(sierraczosolar)

# run the model
solarpv(area=0.1, solar=sierraczosolar, clr="green", eunit="W")

# run and save results - but don't plot
site1 = solarpv(area=0.1, solar=sierraczosolar, clr="green", eunit="W", g=FALSE)
site1$mean
site1$annual

# consider a different pv array that only uses 
# diffuse and has non standard efficiency (0.6)
site2 = solarpv(area=0.1, solar=sierraczosolar, clr="green", eunit="W", g=FALSE, eff=0.6, etype="direct")
site2$mean

# try some additional variations
```

# Informal Sensitivity Analysis

What happens when we vary parameters?

Informal - just try varying them

Helpful tools
  * looping/repeating
  * in R - *purrr* package, also *apply* family of function
  * classic *for* loops
  
If you need it a good source to review working with *purrr* to extract items from list and repeat operations

[R description](purr.tidyverse.org)

[Useful Purrr Resource](https://www.rebeccabarter.com/blog/2019-08-19_purrr/)

# Rmarkdown code for informal sensitivity
```{r sen1, eval=T}

# lets try informal sensitivity analysis again, this time by varying efficiency if we don't know efficiency exactly , lets try 20 samples

# use map from purrr
# notice how map adds the one parameter that is missing from the input list
eff = rnorm(mean=0.6, sd = 0.1, n=20)
site2 = eff %>% map(~solarpv( area=0.1, solar=sierraczosolar, clr="green", eunit="W", g=FALSE, etype="direct", eff=.x ))

head(site2)

# this is pretty messy - but we can extract a useful data structure,lets say we want 
# just the annual data (not the mean annual time series), and then reformat as a data frame with nice column names
tmp = map_df(site2,`[`, c("annual")) 

site2df = data.frame(year = tmp$annual$year, elect= tmp$annual$elect)

# now we could plot
ggplot(site2df, aes(year,elect, group=year ))+geom_boxplot()+labs(y="Electricity generated in W")

# we also might want an average across parameter uncertainty
site2_average = site2df %>% group_by(year) %>% dplyr::summarize(elect=mean(elect))

# now add this to the plot - note that we remove the grouping by using group=1
ggplot(site2df, aes(year,elect, group=year))+geom_boxplot()+labs(y="Electricity in W")+
  geom_line(data=site2_average, aes(year, elect, group=1), col="orange")

# we could also plot how the mean annual electricity varies with efficiency (eff from above)
site2[[1]]

tmp = map_df(site2,`[`, c("mean")) 

# how variable is electricity generation (mean over all time) with uncertainty in solar efficiency

site2_mean = data.frame(eff=eff, elect= tmp)
ggplot(site2_mean, aes(y=mean))+geom_boxplot()+
  labs(x="Electricity in W")

# or to see what the sensitivity looks like
ggplot(site2_mean, aes(eff, mean))+geom_point()+
  labs(y="Electricity in W", x="Solar Efficiency")

```


# On your own, try the following

* Repeat an informal sensitivity analysis where instead of efficiency you vary the threshold solar radiation for power generation (note that the default value is 10000)

* Challenge - how would you do this with a *for* loop instead of *map* functions from *purrr* 

* Challenge - how would you do an informal sensitivity analysis where you varied both efficiency and threshold 


